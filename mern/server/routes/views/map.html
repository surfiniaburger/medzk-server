<!DOCTYPE html>
<html>

<head>
    <title>Zero Kare</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
      .pac-controls {
        display: inline-block;
        padding: 0px 11px;
      }
      .pac-controls label {
        font-family: Roboto;
        font-size: 13px;
        font-weight: 300;
      }
      #pac-card {
  display: flex;
  flex-direction: column;
  gap: 10px;
  background-color: #4d90fe;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  padding: 15px;
  max-width: 400px;
  width: 90%; /* Responsive width */
  margin: 20px auto; /* Center on the page */
  box-sizing: border-box;
}


  /* Home Icon Styling */
.home-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background-color: #ffffff;
  border-radius: 50%;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  text-decoration: none;
  color: #4d90fe;
  font-size: 20px;
  transition: transform 0.3s ease, background-color 0.3s ease;
  margin: 0 auto;
}

.home-icon:hover {
  background-color: #4d90fe;
  color: white;
  transform: scale(1.1);
}

#title {
  font-size: 1.2rem;
  font-weight: bold;
  text-align: center;
  margin-bottom: 10px;
  color: white; 
}

#pac-container {
  display: flex;
  flex-direction: column;
}

.pac-input {
  width: 100%; /* Full width input */
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 1rem;
  box-sizing: border-box;
}

.pac-input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
}

/* Media Query for Larger Screens */
@media (min-width: 768px) {
  #pac-card {
    flex-direction: row;
    align-items: center;
    gap: 15px;
    max-width: 600px;
  }

  #title {
    flex: 1;
    text-align: left;
    margin-bottom: 0;
  }

  #pac-container {
    flex: 2;
  }
}
      #api-results {
  position: fixed; /* Keeps it in the same spot during scroll */
  top: 50%; /* Center vertically */
  left: 20px; /* Positioned slightly away from the left edge */
  transform: translateY(-50%); /* Aligns center properly */
  width: 250px; /* Smaller box */
  background-color: #f9f9f9; /* Light background for better readability */
  border: 1px solid #ddd; /* Subtle border */
  border-radius: 8px; /* Rounded corners for modern look */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Soft shadow */
  padding: 16px; /* Inner spacing */
  font-family: 'Arial', sans-serif; /* Modern font */
  font-size: 14px; /* Readable text size */
  display: none; /* Hidden initially */
  z-index: 1000; /* Makes sure it stays above other elements */
}

#api-results h3 {
  font-size: 16px;
  color: #333; /* Darker text for better visibility */
  margin-bottom: 8px;
  text-align: center; /* Align title in the center */
}

#api-results ul {
  list-style-type: none; /* Removes bullet points */
  padding: 0; /* No extra padding */
  margin: 0; /* No extra margin */
}

#api-results ul li {
  margin-bottom: 6px;
  color: #555; /* Slightly muted text color */
  font-size: 14px;
}

.draggable {
    position: absolute;
    cursor: grab;
    padding: 10px;
    background: white;
    border: 1px solid #ccc;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    z-index: 1000;
}

.info-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 15px;
    max-width: 300px;  /* Reduced from 400px */
    position: relative;
    animation: slideIn 0.3s ease-out;
    overflow: hidden;
    font-size: 0.9rem;  /* Reduced base font size */
}

@keyframes slideIn {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.close-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #ff4757;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;    /* Reduced from 30px */
    height: 24px;   /* Reduced from 30px */
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;  /* Reduced from 18px */
}

.close-btn:hover {
    transform: rotate(90deg);
    background: #ff6b81;
}

.place-title {
    font-size: 1.2em;  /* Reduced from 1.5em */
    color: #2f3542;
    margin-bottom: 10px;
    padding-right: 30px;
}

.info-section {
    margin: 5px 0;     /* Reduced from 8px */
    padding: 5px 8px;  /* Reduced from 8px */
    border-left: 2px solid #70a1ff;  /* Reduced from 3px */
    background: #f1f2f6;
    border-radius: 0 6px 6px 0;
    line-height: 1.3;  /* Added for better text spacing */
}

.place-image {
    width: 100%;
    height: 150px;    /* Fixed height */
    object-fit: cover; /* Ensures image covers area without distortion */
    border-radius: 8px;
    margin: 10px 0;
    transition: transform 0.3s;
}

.rating {
    background: #ffd32a;
    color: #2f3542;
    padding: 3px 8px;
    border-radius: 15px;
    display: inline-block;
    font-weight: bold;
    font-size: 0.9em;
}

.author-link {
    color: #70a1ff;
    text-decoration: none;
    transition: color 0.2s;
}

.author-link:hover {
    color: #1e90ff;
}

/* Added to truncate long text */
.truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.draggable:active {
    cursor: grabbing;
}

.dashboard {
            display: flex;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            font-family: Arial, sans-serif;
            margin-top: -20px;
          
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            overflow: hidden; /* Ensure content is constrained */
            max-height: 300px; /* Set a reasonable maximum height */
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .gauge {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }

        .gauge-bg {
            fill: none;
            stroke: #eee;
            stroke-width: 20;
        }

        .gauge-progress {
            fill: none;
            stroke-width: 20;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 100px 100px;
            transition: stroke-dashoffset 1s ease;
        }


        .place-cards-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  padding: 20px;
  justify-content: center;
}

.place-card {
  background: linear-gradient(145deg, #ffffff, #e6e6e6);
  box-shadow: 6px 6px 12px #d9d9d9, -6px -6px 12px #ffffff;
  border-radius: 12px;
  width: 300px;
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.place-card:hover {
  transform: scale(1.05);
  box-shadow: 8px 8px 16px #cccccc, -8px -8px 16px #ffffff;
}

.place-card img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-bottom: 2px solid #ccc;
}

.place-card-content {
  padding: 15px;
}

.place-card h2 {
  font-size: 1.2rem;
  color: #333;
  margin-bottom: 10px;
}

.place-card p {
  font-size: 0.9rem;
  color: #555;
  margin-bottom: 8px;
}

.place-card a {
  text-decoration: none;
  color: #007bff;
}

.place-card .rating {
  font-weight: bold;
  color: #ffaa00;
}


        .gauge-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
        }

        .pollutant-list {
            list-style: none;
            padding: 0;
            max-height: 200px; /* Set a scrollable area for the list */
    overflow-y: auto; /* Enable vertical scrolling */
    overflow-x: hidden; /* Prevent horizontal overflow */
        }

        .pollutant-item {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            background: #f5f5f5;
            word-wrap: break-word; 
        }

        .progress-bar {
            height: 10px;
            background: #eee;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            transition: width 1s ease;
        }

        /* Add these styles to your existing CSS */

.fab-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
}

.fab-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #4d90fe;
    border: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

.fab-button:hover {
    background: #357ABD;
    transform: scale(1.1);
    animation: none;
}

.fab-icon {
    font-size: 24px;
    color: white;
}

.dashboard-panel {
    position: fixed;
    right: 30px;
    bottom: 100px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    width: 80%;
    max-width: 1200px;
    max-height: 80vh;
    overflow-y: auto;
    display: none;
    animation: slideIn 0.3s ease-out;
    z-index: 999;
}

@keyframes slideIn {
    from {
        transform: translateY(100px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.panel-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #ff4757;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 0.2s;
    z-index: 1001;
}

.panel-close-btn:hover {
    transform: rotate(90deg);
    background: #ff6b81;
}

/* Modify your existing dashboard styles */
.dashboard {
    padding: 30px;
    margin-top: 20px;
}

/* Add overlay style */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 998;
}

#info-window { display: none; }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

</head>

<body>
    <div class="pac-card draggable" id="pac-card">
        <div id="title">Navigate to a place</div>
        <div id="pac-container">
          <input class="pac-input" type="text" id="pac-input" name="pac-input" placeholder="Enter a location..." />
        </div>
        <!-- Home Icon -->
     <a href="https://medzk-server.vercel.app/" class="home-icon"  title="Go to Home">
       <i class="fas fa-home"></i>
     </a>
      </div>

      

    <div id="info-window" class="draggable"></div>

    


  <div class="fab-container">
      <button class="fab-button" id="dashboardButton">
          <span class="fab-icon">üìä</span>
      </button>
  </div>
  
  <div class="dashboard-panel" id="dashboardPanel">
      <button class="panel-close-btn">√ó</button>
      <div class="dashboard">
          <!-- Your existing dashboard content -->
          <div class="card">
              <h2>Air Quality Index</h2>
              <svg class="gauge" viewBox="0 0 200 200">
                  <circle class="gauge-bg" cx="100" cy="100" r="90"/>
                  <circle class="gauge-progress" cx="100" cy="100" r="90"/>
                  <text class="gauge-value" x="100" y="120" text-anchor="middle">0</text>
              </svg>
          </div>
          <div class="card">
              <h2>Temperature & Humidity</h2>
              <canvas id="tempHumidityChart"></canvas>
          </div>
          <div class="card">
              <h2>Pollutants</h2>
              <ul class="pollutant-list" id="pollutantList"></ul>
          </div>
          <div class="card">
              <h2>Health Recommendations</h2>
              <div id="recommendations" style="padding: 20px;"></div>
          </div>
      </div>
  </div>


   <!-- Template variables for API keys -->
   <script>
      window.GOOGLE_MAPS_API_KEY = '{{GOOGLE_MAPS_API_KEY}}';
      window.OPENWEATHER_API_KEY = '{{OPENWEATHER_API_KEY}}';
    </script>

    <!-- Required External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

    <!-- Google Maps Libraries -->
    <script async defer>
        (g => { var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window; b = b[c] || (b[c] = {}); var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => { await (a = m.createElement("script")); e.set("libraries", [...r] + ""); for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]); e.set("callback", c + ".maps." + q); a.src = `https://maps.${c}apis.com/maps/api/js?` + e; d[q] = f; a.onerror = () => h = n(Error(p + " could not load.")); a.nonce = m.querySelector("script[nonce]")?.nonce || ""; m.head.append(a) })); d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n)) })({
            key: window.GOOGLE_MAPS_API_KEY,
            v: "alpha",
        });
    </script>
    <script>
      let map3DElement = null;
      let placesService = null;


      class InteractiveMarker {
    constructor(map3DElement, place) {
        this.map3DElement = map3DElement;
        this.place = place;
        this.marker = null;
    }

    async create() {
        // Import Marker3DInteractiveElement
        const { Marker3DInteractiveElement } = await google.maps.importLibrary("maps3d");
              
        // Create an instance of Marker3DInteractiveElement
        this.marker = new Marker3DInteractiveElement({
            position: {
                lat: this.place.location.lat(),
                lng: this.place.location.lng(),
                altitude: 0, // Assuming altitude is optional
            },
            label: this.place.name,
            sizePreserved: true, // Preserve marker size regardless of zoom
        });

        // Add click event listener to the marker
        this.marker.addEventListener('gmp-click', async () => {
        // Call zoomAndFlyToLocation when marker is clicked
            await zoomAndFlyToLocation(this.map3DElement, {
               lat: this.place.location.lat(),
               lng: this.place.location.lng(),
            });

        // Show info window
        this.showInfoWindow();
    });
        
        // Append the marker to the map's 3D element
        this.map3DElement.append(this.marker);
    }
    

    async showInfoWindow() {
        const infoWindow = document.getElementById("info-window");
        
        // Simulated fetch for additional data
        const data = await this.fetchData();
        
        // Populate and display the info window
        infoWindow.innerHTML = `
           <div class="info-card">
        <button class="close-btn" onclick="this.parentElement.style.display='none'">√ó</button>
        
        <h2 class="place-title truncate">
            üè¢ ${this.place.displayName}
        </h2>
        
        <img src="${this.place.photos && this.place.photos.length > 0 ? 
           this.place.photos[0].getURI({ maxHeight: 150 }) : 
           'https://raw.githubusercontent.com/surfiniaburger/medzk-server/cd1afb17e0058ecf887f340ea8c1839f8925c716/mern/client/src/assets/groot.jpg'}"
            alt="${this.place.displayName}"
            class="place-image"
            onerror="this.src='https://raw.githubusercontent.com/surfiniaburger/medzk-server/cd1afb17e0058ecf887f340ea8c1839f8925c716/mern/client/src/assets/groot.jpg'">
        
        <div class="info-section truncate">
            üìç ${this.place.formattedAddress || "Address not available"}
        </div>
        
        <div class="info-section">
            <span class="rating">‚≠ê ${this.place.reviews[0]?.rating || 'N/A'}</span>
            üë§ ${this.place.reviews[0]?.authorAttribution?.displayName || "Anonymous"}
        </div>
        
        <div class="info-section" style="max-height: 60px; overflow-y: auto;">
            üí≠ ${this.place.reviews[0]?.text || 'No reviews yet'}
        </div>
          </div>

        `;
        infoWindow.style.display = "block";
    }

    async fetchData() {
        // Simulated data fetching with a delay
        return new Promise((resolve) => {
            setTimeout(() => {
                resolve(`Simulated info for ${this.place.displayName}`);
            }, 1000);
        });
    }
}


async function zoomAndFlyToLocation(map3DElement, location) {
    if (!map3DElement) return;

    const initialHeading = map3DElement.heading || 0;

    // Fly to the location
    let currentHeading = initialHeading;
    const steps = 100; // Number of frames for the animation
    const rangeReduction = (map3DElement.range - 300) / steps; // Gradual zoom
    const headingIncrement = 360 / steps; // Rotate the camera 360 degrees
    const intervalDuration = 50; // Duration per frame in milliseconds

    for (let i = 0; i < steps; i++) {
        // Update the map's camera properties gradually
        map3DElement.center = {
            lat: location.lat,
            lng: location.lng,
            altitude: 30, // Zoom close to the pin
        };
        map3DElement.range -= rangeReduction;
        map3DElement.heading = (currentHeading + headingIncrement) % 360; // Rotate around
        map3DElement.tilt = 65;

        currentHeading += headingIncrement;
        await new Promise((resolve) => setTimeout(resolve, intervalDuration));
    }

    console.log("Camera zoomed and flew to the marker position.");
}


// Create overlay element
const overlay = document.createElement('div');
overlay.className = 'overlay';
document.body.appendChild(overlay);

// Get elements
const dashboardButton = document.getElementById('dashboardButton');
const dashboardPanel = document.getElementById('dashboardPanel');
const closeBtn = document.querySelector('.panel-close-btn');

// Toggle dashboard
function toggleDashboard() {
    const isVisible = dashboardPanel.style.display === 'block';
    
    if (isVisible) {
        dashboardPanel.style.display = 'none';
        overlay.style.display = 'none';
    } else {
        dashboardPanel.style.display = 'block';
        overlay.style.display = 'block';
    }
}

// Event listeners
dashboardButton.addEventListener('click', toggleDashboard);
closeBtn.addEventListener('click', toggleDashboard);
overlay.addEventListener('click', toggleDashboard);

// Optional: Close dashboard when pressing Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && dashboardPanel.style.display === 'block') {
        toggleDashboard();
    }
});

    
      async function init() {
        const { Map3DElement } = await google.maps.importLibrary("maps3d");
        map3DElement = new Map3DElement({
          center: { lat: 0, lng: 0, altitude: 16000000 },
         // Adjust as needed
        });

        //await initializeMapAndElements();
        document.body.append(map3DElement);
        initAutocomplete();
        initPlacesService();
      }
    
      async function initAutocomplete() {
        const { Autocomplete } = await google.maps.importLibrary("places");
        const autocomplete = new Autocomplete(
          document.getElementById("pac-input"),
          {
            fields: ["geometry", "name", "place_id"],
          }
        );
    
        autocomplete.addListener("place_changed", () => {
          const place = autocomplete.getPlace();
          if (!place.geometry || !place.geometry.viewport) {
            window.alert("No viewport for input: " + place.name);
            return;
          }
          zoomToViewport(place.geometry);
        });
      }
    
      async function zoomToViewport(geometry) {
        const { AltitudeMode, Polyline3DElement } = await google.maps.importLibrary("maps3d");
        let viewport = geometry.viewport;
        let locationPoints = [
          { lat: viewport.getNorthEast().lat(), lng: viewport.getNorthEast().lng() },
          { lat: viewport.getSouthWest().lat(), lng: viewport.getNorthEast().lng() },
          { lat: viewport.getSouthWest().lat(), lng: viewport.getSouthWest().lng() },
          { lat: viewport.getNorthEast().lat(), lng: viewport.getSouthWest().lng() },
          { lat: viewport.getNorthEast().lat(), lng: viewport.getNorthEast().lng() }
        ];
    
        let locationPolyline = new Polyline3DElement({
          altitudeMode: AltitudeMode.CLAMP_TO_GROUND,
          strokeColor: "blue",
          strokeWidth: 10,
          coordinates: locationPoints,
        });
        map3DElement.append(locationPolyline);
    
        let elevation = await getElevationForPoint(geometry.location);
        if (map3DElement) {
          map3DElement.center = { lat: geometry.location.lat(), lng: geometry.location.lng(), altitude: elevation + 50 };
          map3DElement.heading = 0;
          map3DElement.range = 1000;
          map3DElement.tilt = 65;
        }
    
        initNearbySearch(geometry.location);
        await fetchEnvironmentalData(geometry.location);
      }
    
      async function initPlacesService() {
        const { PlacesService } = await google.maps.importLibrary("places");
        placesService = new PlacesService(map3DElement);
      }
      async function initNearbySearch(location) {
    if (!placesService) {
        console.error("PlacesService not initialized.");
        return;
    }

    const { Place, SearchNearbyRankPreference } = await google.maps.importLibrary("places");
    let center = new google.maps.LatLng(location.lat(), location.lng());
    const request = {
        fields: ["displayName", "location","formattedAddress", "photos", "reviews",  "editorialSummary", "businessStatus"],
        locationRestriction: {
            center: center,
            radius: 1000, // Search within 1km
        },
        includedPrimaryTypes: ["hospital"],
        rankPreference: SearchNearbyRankPreference.POPULARITY,
        language: "en-US",
        region: "us",
        maxResultCount: 10,
    };

    try {
        const { places } = await Place.searchNearby(request);

        if (places && places.length > 0) { // Ensure there are places available
            console.log("Nearby Search Results:", places);

            places.forEach((place, index) => {
                // Check if location data is present
                if (place.location) { // Correctly access the location property
                    const lat = place.location.lat(); // Access latitude using lat() method
                    const lng = place.location.lng(); // Access longitude using lng() method
                    
                    console.log(`Location of Place ${index + 1}:`, {
                        lat: lat,
                        lng: lng
                    });

                    // Create an interactive marker for each place
                    const marker = new InteractiveMarker(map3DElement, place);
                    marker.create();
                } else {
                    console.error(`Place ${index + 1} location data is missing.`);
                }
            });
        } else {
            console.log("No results found.");
        }
    } catch (error) {
        console.error("Nearby search failed:", error);
    }
}

      function addMarker(place) {
        const { Marker3DElement } = google.maps.maps3d;
        const marker = new Marker3DElement({
          position: {
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng(),
            altitude: 0, // Adjust if necessary
          },
          label: place.name,
          sizePreserved: true,
        });
        map3DElement.append(marker);
      }
    
      async function getElevationForPoint(location) {
        const { ElevationService } = await google.maps.importLibrary("elevation");
        const elevatorService = new google.maps.ElevationService();
        const elevationResponse = await elevatorService.getElevationForLocations({
          locations: [location],
        });
    
        if (!(elevationResponse.results && elevationResponse.results.length)) {
          window.alert("Insufficient elevation data.");
          return 0;
        }
        return elevationResponse.results[0].elevation || 10;
      }
      async function fetchEnvironmentalData(location) {
    const googleAirQualityUrl = `https://airquality.googleapis.com/v1/currentConditions:lookup?key=${window.GOOGLE_MAPS_API_KEY}`;
    const openWeatherAirQualityUrl = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${location.lat()}&lon=${location.lng()}&appid=${window.OPENWEATHER_API_KEY}`;
    const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${location.lat()}&lon=${location.lng()}&appid=${window.OPENWEATHER_API_KEY}`;

    const googlePayload = {
        universalAqi: true,
        location: {
            latitude: location.lat(),
            longitude: location.lng(),
        },
        extraComputations: [
            "HEALTH_RECOMMENDATIONS",
            "DOMINANT_POLLUTANT_CONCENTRATION",
            "POLLUTANT_CONCENTRATION",
            "LOCAL_AQI",
            "POLLUTANT_ADDITIONAL_INFO",
        ],
        languageCode: "en",
    };

    try {
        // Try Google Air Quality API first
        const googleAirQualityResponse = await fetch(googleAirQualityUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(googlePayload),
        });

        if (!googleAirQualityResponse.ok) {
            throw new Error("Google Air Quality API request failed");
        }

        const googleAirQualityData = await googleAirQualityResponse.json();
        displayEnvironmentalData({
            source: 'google',
            data: googleAirQualityData
        });

    } catch (googleError) {
        console.warn("Falling back to OpenWeather API due to error:", googleError);

        try {
            // Fallback to OpenWeather API
            const [airQualityResponse, weatherResponse] = await Promise.all([
                fetch(openWeatherAirQualityUrl),
                fetch(weatherUrl),
            ]);

            const airQualityData = await airQualityResponse.json();
            const weatherData = await weatherResponse.json();

            displayEnvironmentalData({
                source: 'openweather',
                data: {
                    airQuality: airQualityData,
                    weather: weatherData
                }
            });
        } catch (fallbackError) {
            console.error("Failed to fetch environmental data:", fallbackError);
            displayError("Unable to fetch environmental data. Please try again later.");
        }
    }
}


function displayEnvironmentalData({ source, data }) {
    // Format data for visualization based on the source
    let formattedData = {
        aqi: 0,
        temperature: [],
        humidity: [],
        pollutants: [],
        recommendations: ''
    };

    if (source === 'google') {
      console.log("I used google")
        // Format Google API data
        formattedData = {
            aqi: data.indexes[0].aqi,
            temperature: [20, 21, 22, 23, 24, 25, 24, 23], // Default temperature data as Google API doesn't provide this
            humidity: [50, 52, 54, 53, 52, 51, 50, 49], // Default humidity data
            pollutants: data.pollutants.map(pollutant => ({
                name: pollutant.displayName,
                value: pollutant.concentration.value,
                unit: pollutant.concentration.units,
                max: getPollutantMaxValue(pollutant.displayName),
                color: getPollutantColor(pollutant.displayName)
            })),
            recommendations: data.healthRecommendations.generalPopulation
        };
    } else if (source === 'openweather') {
        // Format OpenWeather API data
        const airQuality = data.airQuality.list[0];
        const weather = data.weather;
        
        // Generate time-series data for temperature and humidity
        const currentHour = new Date().getHours();
        const tempData = [];
        const humidityData = [];
        for (let i = 0; i < 8; i++) {
            tempData.push((weather.main.temp - 273.15).toFixed(1));
            humidityData.push(weather.main.humidity);
        }

        formattedData = {
            aqi: airQuality.main.aqi * 20, // Convert OpenWeather 1-5 scale to 0-100 scale
            temperature: tempData,
            humidity: humidityData,
            pollutants: [
                {
                    name: 'PM2.5',
                    value: airQuality.components.pm2_5,
                    unit: 'Œºg/m¬≥',
                    max: 50,
                    color: '#FF6384'
                },
                {
                    name: 'PM10',
                    value: airQuality.components.pm10,
                    unit: 'Œºg/m¬≥',
                    max: 100,
                    color: '#36A2EB'
                },
                {
                    name: 'NO2',
                    value: airQuality.components.no2,
                    unit: 'Œºg/m¬≥',
                    max: 100,
                    color: '#FFCE56'
                },
                {
                    name: 'O3',
                    value: airQuality.components.o3,
                    unit: 'Œºg/m¬≥',
                    max: 100,
                    color: '#4BC0C0'
                }
            ],
            recommendations: getAQIRecommendation(airQuality.main.aqi)
        };
    }

    // Update the dashboard with formatted data
    updateDashboard(formattedData);
}

// Helper function to get max values for pollutants
function getPollutantMaxValue(pollutantName) {
    const maxValues = {
        'PM2.5': 50,
        'PM10': 100,
        'NO2': 100,
        'O3': 100,
        'CO': 10000,
        'SO2': 350
    };
    return maxValues[pollutantName] || 100;
}

// Helper function to get colors for pollutants
function getPollutantColor(pollutantName) {
    const colors = {
        'PM2.5': '#FF6384',
        'PM10': '#36A2EB',
        'NO2': '#FFCE56',
        'O3': '#4BC0C0',
        'CO': '#9966FF',
        'SO2': '#FF9F40'
    };
    return colors[pollutantName] || '#999999';
}

// Helper function to get AQI recommendations
function getAQIRecommendation(aqiLevel) {
    const recommendations = {
        1: "Air quality is good. Perfect for outdoor activities!",
        2: "Air quality is fair. Most people can continue outdoor activities.",
        3: "Air quality is moderate. Sensitive individuals should limit prolonged outdoor exposure.",
        4: "Air quality is poor. Avoid prolonged outdoor activities.",
        5: "Air quality is very poor. Stay indoors if possible."
    };
    return recommendations[aqiLevel] || "No specific recommendations available.";
}

// Function to handle errors
function displayError(message) {
    const formattedData = {
        aqi: 0,
        temperature: Array(8).fill(0),
        humidity: Array(8).fill(0),
        pollutants: [],
        recommendations: `Error: ${message}`
    };
    updateDashboard(formattedData);
}

document.addEventListener("DOMContentLoaded", () => {
    const draggables = document.querySelectorAll(".draggable");

    draggables.forEach((element) => {
        element.addEventListener("mousedown", (e) => {
            let shiftX = e.clientX - element.getBoundingClientRect().left;
            let shiftY = e.clientY - element.getBoundingClientRect().top;

            const moveAt = (pageX, pageY) => {
                element.style.left = pageX - shiftX + "px";
                element.style.top = pageY - shiftY + "px";
            };

            const onMouseMove = (event) => {
                moveAt(event.pageX, event.pageY);
            };

            document.addEventListener("mousemove", onMouseMove);

            element.addEventListener("mouseup", () => {
                document.removeEventListener("mousemove", onMouseMove);
                element.onmouseup = null;
            });

            // Prevent default drag-and-drop behavior
            element.ondragstart = () => false;
        });
    });
});



class Marker3DInteractiveElement {
  constructor({ position, label, iconUrl, interactive = true }) {
    this.position = position;
    this.label = label;
    this.iconUrl = iconUrl;
    this.interactive = interactive;
    this.marker = null;
  }

  async create(map3DElement) {
    const { Marker3DElement } = await google.maps.importLibrary("maps3d");
    this.marker = new Marker3DElement({
      position: this.position,
      label: this.label,
      icon: this.iconUrl,
      sizePreserved: true,
    });
    map3DElement.append(this.marker);

    if (this.interactive) {
      this.marker.addEventListener("click", () => {
        new PlaceClick().handleClick(this.position);
      });
    }
  }
}

class PlaceClick {
  handleClick(position) {
    alert(`Clicked on marker at: ${position.lat}, ${position.lng}`);
    // Fetch and display more detailed information or navigate on the map
  }
}

class Model3DElement {
  constructor({ position, modelUrl }) {
    this.position = position;
    this.modelUrl = modelUrl;
    this.model = null;
  }

  async create(map3DElement) {
    const { Model3DElement } = await google.maps.importLibrary("maps3d");
    this.model = new Model3DElement({
      position: this.position,
      model: this.modelUrl,
      scale: 1,
    });
    map3DElement.append(this.model);
  }
}

async function initializeMapAndElements() {
  if (!map3DElement) {
    console.error("map3DElement is not initialized.");
    return;
  }

  const mapCenter = { lat: 40.748817, lng: -73.985428 }; // Example location

  try {
    // Add an interactive marker
    const interactiveMarker = new google.maps.maps3d.Marker3DInteractiveElement({
      position: mapCenter,
      label: "Empire State Building",
    });

    interactiveMarker.addEventListener("gmp-click", () => {
      alert("Clicked on: Empire State Building");
    });

    map3DElement.append(interactiveMarker);

    // Add a 3D model
    const model = new google.maps.maps3d.Model3DElement({
      position: mapCenter,
      src: "https://github.com/surfiniaburger/medzk-server/raw/refs/heads/main/mern/client/src/assets/groot-model.glb",
      scale: 1.0, // Adjust as needed
    });

    map3DElement.append(model);
  } catch (error) {
    console.error("Failed to initialize map and elements:", error);
  }
}   


function updateDashboard(data) {
            // Update AQI Gauge
            updateGauge(data.aqi);
            
            // Update Temperature & Humidity Chart
            updateTempHumidityChart(data.temperature, data.humidity);
            
            // Update Pollutants
            updatePollutants(data.pollutants);
            
            // Update Recommendations
            updateRecommendations(data.recommendations);
        }

        // Gauge animation
        function updateGauge(value) {
            const progress = document.querySelector('.gauge-progress');
            const valueText = document.querySelector('.gauge-value');
            const circumference = 2 * Math.PI * 90;
            const offset = circumference - (value / 500) * circumference;
            
            progress.style.strokeDasharray = circumference;
            progress.style.strokeDashoffset = offset;
            
            // Color based on AQI value
            let color;
            if (value <= 50) color = '#00C853';
            else if (value <= 100) color = '#FFD600';
            else if (value <= 150) color = '#FF6D00';
            else color = '#D50000';
            
            progress.style.stroke = color;
            
            gsap.to(valueText, {
                innerHTML: Math.round(value),
                duration: 1,
                snap: { innerHTML: 1 }
            });
        }

        let tempHumidityChart = null;

        // Temperature & Humidity Chart
        function updateTempHumidityChart(temp, humidity) {
            const ctx = document.getElementById('tempHumidityChart').getContext('2d');

            // Destroy existing chart if it exists
            if (tempHumidityChart) {
                 tempHumidityChart.destroy();
             }
            tempHumidityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['12am', '3am', '6am', '9am', '12pm', '3pm', '6pm', '9pm'],
                    datasets: [{
                        label: 'Temperature (¬∞C)',
                        data: temp,
                        borderColor: '#FF6384',
                        tension: 0.4,
                        fill:false
                    }, {
                        label: 'Humidity (%)',
                        data: humidity,
                        borderColor: '#36A2EB',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    },
                    scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1);
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
                }
            });
        }

        // Optional: Clean up function to be called when needed
       function destroyCharts() {
       if (tempHumidityChart) {
          tempHumidityChart.destroy();
          tempHumidityChart = null;
        }
      }

        // Pollutants List
        function updatePollutants(pollutants) {
            const list = document.getElementById('pollutantList');
            list.innerHTML = '';
            
            pollutants.forEach(pollutant => {
                const item = document.createElement('li');
                item.className = 'pollutant-item';
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <span>${pollutant.name}</span>
                        <span>${pollutant.value} ${pollutant.unit}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="background: ${pollutant.color};"></div>
                    </div>
                `;
                list.appendChild(item);
                
                // Animate progress bar
                setTimeout(() => {
                    item.querySelector('.progress-fill').style.width = `${(pollutant.value / pollutant.max) * 100}%`;
                }, 100);
            });
        }

        // Health Recommendations
        function updateRecommendations(recommendations) {
            const container = document.getElementById('recommendations');
            container.innerHTML = `
                <div style="opacity: 0; transform: translateY(20px);">
                    ${recommendations}
                </div>
            `;
            
            gsap.to(container.children[0], {
                opacity: 1,
                y: 0,
                duration: 0.8,
                ease: "power2.out"
            });
        }

      init();
    </script>
</body>
</html>